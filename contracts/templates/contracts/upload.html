{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center py-5">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h3 class="text-center mb-4 text-primary">رفع عقد جديد للتحليل</h3>
                <form id="upload-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3 text-end">
                        <label class="form-label">عنوان العقد (مثلاً: عقد إيجار شقة)</label>
                        <input type="text" name="title" class="form-control" required placeholder="أدخل اسماً للعقد">
                    </div>
                    <div class="mb-3 text-end">
                        <label class="form-label">ملف العقد (PDF أو Word)</label>
                        <input type="file" name="file" class="form-control" accept=".pdf,.doc,.docx" required>
                    </div>
                    <div class="mb-3 text-end">
                        <label class="form-label">ملاحظات إضافية (اختياري)</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="مثلاً: ركز على بنود الغرامات"></textarea>
                    </div>

                    <button type="submit" id="submit-button" class="btn btn-primary w-100 py-2 fw-bold">
                        رفع وتحليل (10 دولار)
                    </button>
                </form>

                <div id="loading-spinner" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">جاري تجهيز بوابة الدفع الآمنة...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const form = document.getElementById('upload-form');
    const btn = document.getElementById('submit-button');
    const spinner = document.getElementById('loading-spinner');

    form.onsubmit = async (e) => {
        e.preventDefault();
        btn.disabled = true;
        spinner.classList.remove('d-none');

        const formData = new FormData(form);

        // إرسال البيانات إلى السيرفر لإنشاء جلسة الدفع
        const response = await fetch('{% url "upload_contract" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const session = await response.json();

        if (session.id) {
            // توجيه العميل إلى صفحة دفع Stripe
            stripe.redirectToCheckout({ sessionId: session.id });
        } else {
            alert('خطأ في الاتصال: ' + session.error);
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    };
</script>
{% endblock %}