{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0">طلب خدمة: {{ service_name }}</h2>
                </div>
                <div class="card-body p-5">

                    <form id="request-form" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="form-label fw-bold">عنوان العقد/الطلب</label>
                            <input type="text" name="title" class="form-control" placeholder="مثلاً: عقد توريد شركة..." required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">ارفع ملف العقد أو البيانات</label>
                            <input type="file" name="file" id="contract-file" class="form-control"
                                   accept=".pdf,.doc,.docx,.csv,.xlsx,.xls" required>
                            <div class="form-text text-muted">يدعم PDF, Word, Excel, CSV (بحد أقصى 10 ميجابايت).</div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">ملاحظات للمحامي (اختياري)</label>
                            <textarea name="user_notes" id="user-notes" class="form-control" rows="4"
                                      placeholder="اكتب أي نقاط محددة تود التركيز عليها..."></textarea>
                        </div>

                        <hr class="my-4">

                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <span>رسوم الخدمة:</span>
                            <span class="fw-bold fs-4">50.00 USD</span>
                        </div>

                        <div id="paypal-button-container"></div>
                    </form>

                    <div id="processing-section" style="display: none;" class="text-center my-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                        <h4 id="status-message">جاري بدء المعالجة...</h4>
                        <div class="progress mt-4" style="height: 25px; border-radius: 15px;">
                            <div id="main-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar" style="width: 0%;">0%</div>
                        </div>
                        <p class="text-muted mt-3 italic" id="sub-message">برجاء عدم إغلاق الصفحة، يتم فحص الملف قانونياً...</p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>

<script>
    const form = document.getElementById('request-form');
    const processingSection = document.getElementById('processing-section');
    const paypalContainer = document.getElementById('paypal-button-container');

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: { value: '50.00' },
                    description: "خدمة قانونية - {{ service_name }}"
                }]
            });
        },

        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // 1. إخفاء النموذج وإظهار شريط التقدم
                form.style.display = 'none';
                processingSection.style.display = 'block';

                let progressBar = document.getElementById('main-progress-bar');
                let statusMsg = document.getElementById('status-message');

                // تحريك شريط التقدم وهمياً لإعطاء شعور بالمعالجة
                let width = 0;
                let interval = setInterval(function() {
                    if (width >= 90) {
                        clearInterval(interval);
                    } else {
                        width += 15;
                        progressBar.style.width = width + '%';
                        progressBar.innerHTML = width + '%';

                        if(width == 30) statusMsg.innerHTML = "جاري قراءة نص الملف...";
                        if(width == 60) statusMsg.innerHTML = "جاري تحليل الالتزامات القانونية...";
                        if(width == 90) statusMsg.innerHTML = "جاري حفظ التقرير النهائي...";
                    }
                }, 500);

                // 2. إرسال البيانات للسيرفر
                const formData = new FormData(form);
                formData.append('paypal_order_id', details.id);

                return fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json())
                .then(result => {
                    if (result.status === 'success' || result.id) {
                        // اكتمال الشريط وتوجيه المستخدم لصفحة النتائج
                        progressBar.style.width = '100%';
                        progressBar.innerHTML = '100%';
                        statusMsg.innerHTML = "تم بنجاح! جاري عرض النتائج...";

                        setTimeout(function() {
                            window.location.href = '/contract/' + (result.id) + '/';
                        }, 1500);
                    } else {
                        alert('حدث خطأ: ' + result.error);
                        location.reload(); // إعادة التحميل في حال الخطأ
                    }
                });
            });
        },

        onError: function(err) {
            alert('حدث خطأ في بوابة الدفع، يرجى المحاولة مرة أخرى.');
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}